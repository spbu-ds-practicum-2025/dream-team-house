name: Deploy to Production

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build_desktop_windows:
    name: Build Desktop (Windows)
    runs-on: windows-latest
    env:
      TEXT_SERVICE_A_DOMAIN: ${{ secrets.TEXT_SERVICE_A_DOMAIN }}
      CHAT_SERVICE_DOMAIN: ${{ secrets.CHAT_SERVICE_DOMAIN }}
      ANALYTICS_SERVICE_DOMAIN: ${{ secrets.ANALYTICS_SERVICE_DOMAIN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # install-qt-action relies on Python (aqt) being available on PATH
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.3'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          modules: 'qtcharts'
          cache: true

      - name: Configure desktop app
        shell: pwsh
        run: |
          $env:Path = "$env:Qt6_DIR\bin;$env:Path"
          $apiUrl = if ($env:TEXT_SERVICE_A_DOMAIN) { "https://$($env:TEXT_SERVICE_A_DOMAIN)" } else { "" }
          $chatUrl = if ($env:CHAT_SERVICE_DOMAIN) { "https://$($env:CHAT_SERVICE_DOMAIN)" } else { "" }
          $analyticsUrl = if ($env:ANALYTICS_SERVICE_DOMAIN) { "https://$($env:ANALYTICS_SERVICE_DOMAIN)" } else { "" }
          cmake -S services/desktop-app -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DTEXT_API_URL="$apiUrl" `
            -DCHAT_API_URL="$chatUrl" `
            -DANALYTICS_API_URL="$analyticsUrl" `
            -DCMAKE_PREFIX_PATH="$env:Qt6_DIR"

      - name: Build desktop app
        shell: pwsh
        run: |
          $env:Path = "$env:Qt6_DIR\bin;$env:Path"
          cmake --build build --config Release

      - name: Bundle portable package
        shell: pwsh
        run: |
          $env:PATH = "$env:Qt6_DIR\bin;$env:PATH"
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $binaryPath = "build\bin\dream-team-desktop.exe"
          if (-not (Test-Path $binaryPath)) {
            $binaryPath = "build\bin\Release\dream-team-desktop.exe"
          }
          if (-not (Test-Path $binaryPath)) {
            $binaryPath = "build\Release\dream-team-desktop.exe"
          }
          if (-not (Test-Path $binaryPath)) {
            throw "dream-team-desktop.exe not found in expected build output locations."
          }
          Copy-Item $binaryPath dist\
          & "$env:Qt6_DIR\bin\windeployqt.exe" --release dist\dream-team-desktop.exe --dir dist

      - name: Create desktop zip
        shell: pwsh
        run: Compress-Archive -Path dist\* -DestinationPath dream-team-house-desktop-win-x64.zip -Force

      - name: Upload desktop artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-win-x64
          path: dream-team-house-desktop-win-x64.zip

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build_desktop_windows
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download desktop artifact
        uses: actions/download-artifact@v4
        with:
          name: desktop-win-x64
          path: desktop-artifact

      - name: Install sshpass and prepare known_hosts
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          if [ -n "${DEPLOY_PORT:-}" ]; then
            ssh-keyscan -p "$DEPLOY_PORT" -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          fi

      - name: Deploy to server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PASS: ${{ secrets.DEPLOY_PASS }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}

          TEXT_SERVICE_A_DOMAIN: ${{ secrets.TEXT_SERVICE_A_DOMAIN }}
          TEXT_SERVICE_B_DOMAIN: ${{ secrets.TEXT_SERVICE_B_DOMAIN }}
          TEXT_SERVICE_C_DOMAIN: ${{ secrets.TEXT_SERVICE_C_DOMAIN }}
          ANALYTICS_SERVICE_DOMAIN: ${{ secrets.ANALYTICS_SERVICE_DOMAIN }}
          CHAT_SERVICE_DOMAIN: ${{ secrets.CHAT_SERVICE_DOMAIN }}
          FRONTEND_DOMAIN: ${{ secrets.FRONTEND_DOMAIN }}

          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CERTBOT_EMAIL: ${{ secrets.CERTBOT_EMAIL }}

          POSTGRES_TEXT_PASSWORD: ${{ secrets.POSTGRES_TEXT_PASSWORD }}
          POSTGRES_ANALYTICS_PASSWORD: ${{ secrets.POSTGRES_ANALYTICS_PASSWORD }}
        run: |
          set -euo pipefail
          DESKTOP_ZIP="desktop-artifact/dream-team-house-desktop-win-x64.zip"
          DOWNLOADS_DIR="/opt/dream-team-house/downloads/desktop/windows/x64"

          if [ ! -f "$DESKTOP_ZIP" ]; then
            echo "Desktop zip not found at $DESKTOP_ZIP"
            exit 1
          fi

          SSH_PORT_OPTION=""
          SCP_PORT_OPTION=""
          if [ -n "${DEPLOY_PORT:-}" ]; then
            SSH_PORT_OPTION="-p ${DEPLOY_PORT}"
            SCP_PORT_OPTION="-P ${DEPLOY_PORT}"
          fi
          SSH_BASE_OPTS="-o StrictHostKeyChecking=yes -o PreferredAuthentications=password -o PubkeyAuthentication=no -o ServerAliveInterval=15 -o ServerAliveCountMax=4 ${SSH_PORT_OPTION}"
          SCP_BASE_OPTS="-o StrictHostKeyChecking=yes -o PreferredAuthentications=password -o PubkeyAuthentication=no -o ServerAliveInterval=15 -o ServerAliveCountMax=4 ${SCP_PORT_OPTION}"
          
          echo "=== Preparing deployment directory on server ==="
          sshpass -p "${DEPLOY_PASS}" ssh ${SSH_BASE_OPTS} "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "sudo mkdir -p /opt/dream-team-house ${DOWNLOADS_DIR} && sudo chown -R ${DEPLOY_USER}:${DEPLOY_USER} /opt/dream-team-house && sudo chmod 755 /opt/dream-team-house ${DOWNLOADS_DIR}"

          echo "=== Creating Traefik dynamic.yml from template ==="
          sed -e "s|__FRONTEND_DOMAIN__|${FRONTEND_DOMAIN}|g" \
              -e "s|__TEXT_SERVICE_A_DOMAIN__|${TEXT_SERVICE_A_DOMAIN}|g" \
              -e "s|__TEXT_SERVICE_B_DOMAIN__|${TEXT_SERVICE_B_DOMAIN}|g" \
              -e "s|__TEXT_SERVICE_C_DOMAIN__|${TEXT_SERVICE_C_DOMAIN}|g" \
              -e "s|__CHAT_SERVICE_DOMAIN__|${CHAT_SERVICE_DOMAIN}|g" \
              -e "s|__ANALYTICS_SERVICE_DOMAIN__|${ANALYTICS_SERVICE_DOMAIN}|g" \
              services/traefik/dynamic.yml.template > services/traefik/dynamic.yml

          # Validate all placeholders were substituted
          remaining_placeholders=$(grep "__.*__" services/traefik/dynamic.yml || true)
          if [ -n "$remaining_placeholders" ]; then
            echo "ERROR: dynamic.yml still contains placeholder values!"
            echo "$remaining_placeholders"
            exit 1
          fi

          echo "=== Uploading desktop bundle ==="
          sshpass -p "${DEPLOY_PASS}" scp ${SCP_BASE_OPTS} "${DESKTOP_ZIP}" "${DEPLOY_USER}@${DEPLOY_HOST}:${DOWNLOADS_DIR}/latest.zip.tmp"
          sshpass -p "${DEPLOY_PASS}" ssh ${SSH_BASE_OPTS} "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "cd ${DOWNLOADS_DIR} && mv latest.zip.tmp latest.zip"

          echo "=== Workspace size (top dirs) ==="
          du -h -d 2 . | sort -h | tail -n 30
          
          echo "=== File count (top dirs) ==="
          find . -maxdepth 2 -type f | wc -l
          echo "=== What will be copied (./*) ==="
          ls -la
          
          echo "=== Copying files to server (tar.gz) ==="
          ARCHIVE="/tmp/dream-team-house-deploy-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}.tgz"
          
          tar -C . -czf "${ARCHIVE}" \
          --exclude='.git' \
          --exclude='desktop-artifact' \
          .
          
          sshpass -p "${DEPLOY_PASS}" scp ${SCP_BASE_OPTS} "${ARCHIVE}" \
          "${DEPLOY_USER}@${DEPLOY_HOST}:/opt/dream-team-house/deploy.tgz.tmp"
          
          rm -f "${ARCHIVE}"
          
          sshpass -p "${DEPLOY_PASS}" ssh ${SSH_BASE_OPTS} "${DEPLOY_USER}@${DEPLOY_HOST}" \
          "set -euo pipefail; \
           cd /opt/dream-team-house; \
           mv deploy.tgz.tmp deploy.tgz; \
           tar -xzf deploy.tgz; \
           rm -f deploy.tgz"
  
          echo "=== Creating .env file on server ==="
          umask 077  # Set restrictive permissions for env_file
          cat > env_file << EOF
          OPENAI_API_KEY=${OPENAI_API_KEY}
          CERTBOT_EMAIL=${CERTBOT_EMAIL}
          TEXT_SERVICE_A_DOMAIN=${TEXT_SERVICE_A_DOMAIN}
          TEXT_SERVICE_B_DOMAIN=${TEXT_SERVICE_B_DOMAIN}
          TEXT_SERVICE_C_DOMAIN=${TEXT_SERVICE_C_DOMAIN}
          ANALYTICS_SERVICE_DOMAIN=${ANALYTICS_SERVICE_DOMAIN}
          CHAT_SERVICE_DOMAIN=${CHAT_SERVICE_DOMAIN}
          FRONTEND_DOMAIN=${FRONTEND_DOMAIN}
          POSTGRES_TEXT_PASSWORD=${POSTGRES_TEXT_PASSWORD}
          POSTGRES_ANALYTICS_PASSWORD=${POSTGRES_ANALYTICS_PASSWORD}
          EOF

          sshpass -p "${DEPLOY_PASS}" scp ${SCP_BASE_OPTS} env_file "${DEPLOY_USER}@${DEPLOY_HOST}":/opt/dream-team-house/.env
          rm env_file

          echo "=== Setting secure permissions on .env file ==="
          sshpass -p "${DEPLOY_PASS}" ssh ${SSH_BASE_OPTS} "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "chmod 600 /opt/dream-team-house/.env"

          echo "=== Executing deployment on server ==="
          sshpass -p "${DEPLOY_PASS}" ssh ${SSH_BASE_OPTS} "${DEPLOY_USER}@${DEPLOY_HOST}" bash << 'REMOTE_COMMANDS'
          set -euo pipefail
          cd /opt/dream-team-house

          # fail fast if required env missing
          source .env || true
          : "${CERTBOT_EMAIL:?CERTBOT_EMAIL is required}"
          : "${FRONTEND_DOMAIN:?FRONTEND_DOMAIN is required}"
          : "${POSTGRES_TEXT_PASSWORD:?POSTGRES_TEXT_PASSWORD is required}"
          : "${POSTGRES_ANALYTICS_PASSWORD:?POSTGRES_ANALYTICS_PASSWORD is required}"

          echo "=== Docker versions ==="
          docker --version
          docker compose version

          echo "=== Stopping existing containers ==="
          docker compose -f docker-compose.prod.yml down 2>/dev/null || true

          echo "=== Starting services ==="
          docker compose -f docker-compose.prod.yml up -d --build

          echo "=== Waiting for services to start ==="
          sleep 15

          echo "=== Traefik logs (last 200 lines) ==="
          docker logs dream-team-house-traefik-1 --tail 200 || true

          echo "=== Hard check: Traefik must see Docker provider ==="
          if docker logs dream-team-house-traefik-1 --tail 200 | grep -q "client version 1.24 is too old"; then
            echo "Traefik cannot talk to Docker provider. Failing deploy."
            exit 1
          fi

          echo "=== Hard check: HTTPS must not return 404 on frontend ==="
          # retry a bit because routers may appear shortly after start
          for i in $(seq 1 20); do
            code="$(curl -sk -o /dev/null -w '%{http_code}' "https://${FRONTEND_DOMAIN}/" || true)"
            if [ "$code" != "404" ] && [ "$code" != "000" ]; then
              echo "Frontend reachable, HTTP code: $code"
              break
            fi
            echo "Waiting frontend router... attempt $i (code=$code)"
            sleep 3
          done

          code="$(curl -sk -o /dev/null -w '%{http_code}' "https://${FRONTEND_DOMAIN}/" || true)"
          if [ "$code" = "404" ] || [ "$code" = "000" ]; then
            echo "Frontend still not reachable via Traefik (code=$code)."
            exit 1
          fi

          echo "=== Hard check: certificate should not be TRAEFIK DEFAULT CERT ==="
          # Wait up to ~2 minutes for LE
          for i in $(seq 1 20); do
            subj="$(echo | openssl s_client -servername "${FRONTEND_DOMAIN}" -connect "${FRONTEND_DOMAIN}:443" 2>/dev/null \
              | openssl x509 -noout -subject 2>/dev/null || true)"
            iss="$(echo | openssl s_client -servername "${FRONTEND_DOMAIN}" -connect "${FRONTEND_DOMAIN}:443" 2>/dev/null \
              | openssl x509 -noout -issuer 2>/dev/null || true)"

            echo "Attempt $i: $subj ; $iss"

            if echo "$subj $iss" | grep -q "TRAEFIK DEFAULT CERT"; then
              sleep 6
              continue
            fi

            # –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —Å—Ç—Ä–æ–≥–æ –∏–º–µ–Ω–Ω–æ LE:
            if echo "$iss" | grep -qi "Let's Encrypt"; then
              echo "Let's Encrypt cert is active."
              break
            fi

            # –Ω–µ LE, –Ω–æ –∏ –Ω–µ default ‚Äî —Ç–æ–∂–µ –æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä Cloudflare origin cert)
            echo "Cert is not default anymore."
            break
          done

          echo "=== Service Status ==="
          docker compose -f docker-compose.prod.yml ps

          echo "=== Deployment completed successfully ==="
          echo "=== Hard check: downloads URL ==="
          code="$(curl -sk -o /dev/null -w '%{http_code}' "https://${FRONTEND_DOMAIN}/downloads/desktop/windows/x64/latest.zip" || true)"
          if [ "$code" != "200" ]; then
            echo "Downloads endpoint returned $code"
            exit 1
          fi
          REMOTE_COMMANDS

          echo "‚úÖ Deployment complete!"
          echo "üåê Application should be available at: https://${FRONTEND_DOMAIN}"
          echo "To check logs:"
          echo "  ssh ${DEPLOY_USER}@${DEPLOY_HOST} 'cd /opt/dream-team-house && docker compose -f docker-compose.prod.yml logs -f --tail=200'"
