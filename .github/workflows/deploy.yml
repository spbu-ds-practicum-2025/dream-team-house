name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass and prepare known_hosts
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          if [ -n "${DEPLOY_PORT:-}" ]; then
            ssh-keyscan -p "$DEPLOY_PORT" -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          fi

      - name: Deploy to server
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PASS: ${{ secrets.DEPLOY_PASS }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}

          TEXT_SERVICE_A_DOMAIN: ${{ secrets.TEXT_SERVICE_A_DOMAIN }}
          TEXT_SERVICE_B_DOMAIN: ${{ secrets.TEXT_SERVICE_B_DOMAIN }}
          TEXT_SERVICE_C_DOMAIN: ${{ secrets.TEXT_SERVICE_C_DOMAIN }}
          ANALYTICS_SERVICE_DOMAIN: ${{ secrets.ANALYTICS_SERVICE_DOMAIN }}
          CHAT_SERVICE_DOMAIN: ${{ secrets.CHAT_SERVICE_DOMAIN }}
          FRONTEND_DOMAIN: ${{ secrets.FRONTEND_DOMAIN }}

          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CERTBOT_EMAIL: ${{ secrets.CERTBOT_EMAIL }}

          POSTGRES_TEXT_PASSWORD: ${{ secrets.POSTGRES_TEXT_PASSWORD }}
          POSTGRES_ANALYTICS_PASSWORD: ${{ secrets.POSTGRES_ANALYTICS_PASSWORD }}
        run: |
          set -euo pipefail

          SSH_PORT_OPTION=""
          SCP_PORT_OPTION=""
          if [ -n "${DEPLOY_PORT:-}" ]; then
            SSH_PORT_OPTION="-p ${DEPLOY_PORT}"
            SCP_PORT_OPTION="-P ${DEPLOY_PORT}"
          fi
          SSH_BASE_OPTS="-o StrictHostKeyChecking=yes -o PreferredAuthentications=password -o PubkeyAuthentication=no ${SSH_PORT_OPTION}"
          SCP_BASE_OPTS="-o StrictHostKeyChecking=yes -o PreferredAuthentications=password -o PubkeyAuthentication=no ${SCP_PORT_OPTION}"

          echo "=== Preparing deployment directory on server ==="
          sshpass -p "${DEPLOY_PASS}" ssh ${SSH_BASE_OPTS} "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "sudo mkdir -p /opt/dream-team-house && sudo chown ${DEPLOY_USER}:${DEPLOY_USER} /opt/dream-team-house && sudo chmod 755 /opt/dream-team-house"

          echo "=== Creating Traefik dynamic.yml from template ==="
          sed -e "s|__FRONTEND_DOMAIN__|${FRONTEND_DOMAIN}|g" \
              -e "s|__TEXT_SERVICE_A_DOMAIN__|${TEXT_SERVICE_A_DOMAIN}|g" \
              -e "s|__TEXT_SERVICE_B_DOMAIN__|${TEXT_SERVICE_B_DOMAIN}|g" \
              -e "s|__TEXT_SERVICE_C_DOMAIN__|${TEXT_SERVICE_C_DOMAIN}|g" \
              -e "s|__CHAT_SERVICE_DOMAIN__|${CHAT_SERVICE_DOMAIN}|g" \
              -e "s|__ANALYTICS_SERVICE_DOMAIN__|${ANALYTICS_SERVICE_DOMAIN}|g" \
              services/traefik/dynamic.yml.template > services/traefik/dynamic.yml

          # Validate all placeholders were substituted
          if grep -q "__.*__" services/traefik/dynamic.yml; then
            echo "ERROR: dynamic.yml still contains placeholder values!"
            grep "__.*__" services/traefik/dynamic.yml
            exit 1
          fi

          echo "=== Copying files to server ==="
          sshpass -p "${DEPLOY_PASS}" scp ${SCP_BASE_OPTS} -r ./* "${DEPLOY_USER}@${DEPLOY_HOST}":/opt/dream-team-house/

          echo "=== Creating .env file on server ==="
          umask 077  # Set restrictive permissions for env_file
          cat > env_file << EOF
          OPENAI_API_KEY=${OPENAI_API_KEY}
          CERTBOT_EMAIL=${CERTBOT_EMAIL}
          TEXT_SERVICE_A_DOMAIN=${TEXT_SERVICE_A_DOMAIN}
          TEXT_SERVICE_B_DOMAIN=${TEXT_SERVICE_B_DOMAIN}
          TEXT_SERVICE_C_DOMAIN=${TEXT_SERVICE_C_DOMAIN}
          ANALYTICS_SERVICE_DOMAIN=${ANALYTICS_SERVICE_DOMAIN}
          CHAT_SERVICE_DOMAIN=${CHAT_SERVICE_DOMAIN}
          FRONTEND_DOMAIN=${FRONTEND_DOMAIN}
          POSTGRES_TEXT_PASSWORD=${POSTGRES_TEXT_PASSWORD}
          POSTGRES_ANALYTICS_PASSWORD=${POSTGRES_ANALYTICS_PASSWORD}
          EOF

          sshpass -p "${DEPLOY_PASS}" scp ${SCP_BASE_OPTS} env_file "${DEPLOY_USER}@${DEPLOY_HOST}":/opt/dream-team-house/.env
          rm env_file

          echo "=== Setting secure permissions on .env file ==="
          sshpass -p "${DEPLOY_PASS}" ssh ${SSH_BASE_OPTS} "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "chmod 600 /opt/dream-team-house/.env"

          echo "=== Executing deployment on server ==="
          sshpass -p "${DEPLOY_PASS}" ssh ${SSH_BASE_OPTS} "${DEPLOY_USER}@${DEPLOY_HOST}" bash << 'REMOTE_COMMANDS'
          set -euo pipefail
          cd /opt/dream-team-house

          # fail fast if required env missing
          source .env || true
          : "${CERTBOT_EMAIL:?CERTBOT_EMAIL is required}"
          : "${FRONTEND_DOMAIN:?FRONTEND_DOMAIN is required}"
          : "${POSTGRES_TEXT_PASSWORD:?POSTGRES_TEXT_PASSWORD is required}"
          : "${POSTGRES_ANALYTICS_PASSWORD:?POSTGRES_ANALYTICS_PASSWORD is required}"

          echo "=== Docker versions ==="
          docker --version
          docker compose version

          echo "=== Stopping existing containers ==="
          docker compose -f docker-compose.prod.yml down 2>/dev/null || true

          echo "=== Starting services ==="
          docker compose -f docker-compose.prod.yml up -d --build

          echo "=== Waiting for services to start ==="
          sleep 15

          echo "=== Traefik logs (last 200 lines) ==="
          docker logs dream-team-house-traefik-1 --tail 200 || true

          echo "=== Hard check: Traefik must see Docker provider ==="
          if docker logs dream-team-house-traefik-1 --tail 200 | grep -q "client version 1.24 is too old"; then
            echo "Traefik cannot talk to Docker provider. Failing deploy."
            exit 1
          fi

          echo "=== Hard check: HTTPS must not return 404 on frontend ==="
          # retry a bit because routers may appear shortly after start
          for i in $(seq 1 20); do
            code="$(curl -sk -o /dev/null -w '%{http_code}' "https://${FRONTEND_DOMAIN}/" || true)"
            if [ "$code" != "404" ] && [ "$code" != "000" ]; then
              echo "Frontend reachable, HTTP code: $code"
              break
            fi
            echo "Waiting frontend router... attempt $i (code=$code)"
            sleep 3
          done

          code="$(curl -sk -o /dev/null -w '%{http_code}' "https://${FRONTEND_DOMAIN}/" || true)"
          if [ "$code" = "404" ] || [ "$code" = "000" ]; then
            echo "Frontend still not reachable via Traefik (code=$code)."
            exit 1
          fi

          echo "=== Hard check: certificate should not be TRAEFIK DEFAULT CERT ==="
          # Wait up to ~2 minutes for LE
          for i in $(seq 1 20); do
            subj="$(echo | openssl s_client -servername "${FRONTEND_DOMAIN}" -connect "${FRONTEND_DOMAIN}:443" 2>/dev/null \
              | openssl x509 -noout -subject 2>/dev/null || true)"
            iss="$(echo | openssl s_client -servername "${FRONTEND_DOMAIN}" -connect "${FRONTEND_DOMAIN}:443" 2>/dev/null \
              | openssl x509 -noout -issuer 2>/dev/null || true)"

            echo "Attempt $i: $subj ; $iss"

            if echo "$subj $iss" | grep -q "TRAEFIK DEFAULT CERT"; then
              sleep 6
              continue
            fi

            # –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —Å—Ç—Ä–æ–≥–æ –∏–º–µ–Ω–Ω–æ LE:
            if echo "$iss" | grep -qi "Let's Encrypt"; then
              echo "Let's Encrypt cert is active."
              break
            fi

            # –Ω–µ LE, –Ω–æ –∏ –Ω–µ default ‚Äî —Ç–æ–∂–µ –æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä Cloudflare origin cert)
            echo "Cert is not default anymore."
            break
          done

          echo "=== Service Status ==="
          docker compose -f docker-compose.prod.yml ps

          echo "=== Deployment completed successfully ==="
          REMOTE_COMMANDS

          echo "‚úÖ Deployment complete!"
          echo "üåê Application should be available at: https://${FRONTEND_DOMAIN}"
          echo "To check logs:"
          echo "  ssh ${DEPLOY_USER}@${DEPLOY_HOST} 'cd /opt/dream-team-house && docker compose -f docker-compose.prod.yml logs -f --tail=200'"