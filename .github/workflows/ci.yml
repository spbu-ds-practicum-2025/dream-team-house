name: CI/CD Pipeline

on:
  push:
    branches:  [main, develop, 'copilot/**']
  pull_request:
    branches: [main, develop]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

permissions:
  contents: read

jobs:
  # Unit Tests - Run tests for all services
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read

    strategy:
      matrix:
        service:
          - text-service
          - chat-service
          - analytics-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version:  '3.11'
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./services/${{ matrix.service }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run unit tests
        working-directory: ./services/${{ matrix.service }}
        run: |
          python -m pytest tests/ -v --tb=short

  # AI Agent Tests
  test-ai-agent:
    name: AI Agent Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/ai-agent/package-lock.json

      - name: Install dependencies
        working-directory: ./services/ai-agent
        run: npm ci

      - name: Run unit tests
        working-directory: ./services/ai-agent
        run: npm test

  # Build Docker Images
  build:
    name: Build Docker Images
    runs-on:  ubuntu-latest
    needs: [test-unit, test-ai-agent]
    permissions:
      contents: read

    strategy:
      matrix:
        service:
          - text-service
          - chat-service
          - analytics-service
          - ai-agent
          - load-balancer

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./services/${{ matrix.service }}
          file: ./services/${{ matrix.service }}/Dockerfile
          push: false
          tags: ${{ matrix. service }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Integration Tests
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read

    services:
      postgres-text:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: textservice
          POSTGRES_USER: textservice
          POSTGRES_PASSWORD:  textservice_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      postgres-analytics:
        image:  postgres:15-alpine
        env:
          POSTGRES_DB:  analytics
          POSTGRES_USER:  analytics
          POSTGRES_PASSWORD:  analytics_password
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name:  Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name:  Install text-service dependencies
        working-directory: ./services/text-service
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements. txt

      - name:  Start Text Service
        working-directory: ./services/text-service
        env:
          DATABASE_URL: postgresql://textservice:textservice_password@localhost:5432/textservice
          NODE_ID:  node-test
          NODE_NAME: TestNode
          ANALYTICS_URL: http://localhost:8001
        run: |
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 5

      - name: Start Chat Service
        working-directory: ./services/chat-service
        env:
          REDIS_URL: redis://localhost:6379
        run: |
          pip install -r requirements.txt
          uvicorn app.main:app --host 0.0.0.0 --port 8002 &
          sleep 3

      - name: Start Analytics Service
        working-directory: ./services/analytics-service
        env:
          DATABASE_URL: postgresql://analytics:analytics_password@localhost:5433/analytics
        run: |
          pip install -r requirements.txt
          uvicorn app.main:app --host 0.0.0.0 --port 8001 &
          sleep 3

      - name:  Run integration tests
        run: |
          # Test Text Service
          curl -f http://localhost:8000/health || exit 1
          
          # Initialize document
          curl -X POST http://localhost:8000/api/document/init \
            -H "Content-Type: application/json" \
            -d '{"topic": "Test", "initial_text": "Hello World"}' || exit 1
          
          # Get document
          curl -f http://localhost:8000/api/document/current || exit 1
          
          # Test Chat Service
          curl -f http://localhost:8002/health || exit 1
          
          # Post message
          curl -X POST http://localhost:8002/api/chat/messages \
            -H "Content-Type:  application/json" \
            -d '{"agent_id": "test", "message": "Test message"}' || exit 1
          
          # Get messages
          curl -f http://localhost:8002/api/chat/messages || exit 1
          
          # Test Analytics Service
          curl -f http://localhost:8001/health || exit 1
          
          # Get metrics
          curl -f "http://localhost:8001/api/analytics/metrics?period=1h" || exit 1
          
          echo "✅ All integration tests passed"

  # Docker Compose E2E Test
  test-e2e:
    name: E2E Test with Docker Compose
    runs-on: ubuntu-latest
    needs: build
    if: github. event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    permissions:
      contents: read

    steps:
      - name:  Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" > .env

      - name: Start services with Docker Compose
        run:  |
          docker compose up -d
          sleep 30

      - name: Check service health
        run: |
          curl -f http://localhost/health || exit 1
          docker compose ps

      - name:  Initialize document
        run: |
          curl -X POST http://localhost/api/document/init \
            -H "Content-Type:  application/json" \
            -d '{"topic": "E2E Test", "initial_text":  "Starting document for E2E test"}' || exit 1

      - name: Check agents are running
        run: |
          docker compose logs ai-agent | head -20

      - name: Wait for some edits
        run: sleep 60

      - name: Check document changed
        run: |
          RESPONSE=$(curl -s http://localhost/api/document/current)
          VERSION=$(echo $RESPONSE | jq -r '.version')
          if [ "$VERSION" -gt 1 ]; then
            echo "✅ Document has been edited (version: $VERSION)"
          else
            echo "❌ No edits were made"
            exit 1
          fi

      - name: Check metrics
        run: |
          curl -f "http://localhost/api/analytics/metrics?period=1h" || exit 1

      - name: Show logs on failure
        if: failure()
        run: |
          docker compose logs --tail=50

      - name: Stop services
        if: always()
        run: docker compose down -v

  # Lint and Code Quality
  lint:
    name: Lint and Code Quality
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name:  Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort

      - name: Lint Python services
        run: |
          # Check Python files with flake8 (relaxed rules)
          find services/text-service services/chat-service services/analytics-service -name "*.py" | \
            xargs flake8 --max-line-length=120 --ignore=E501,W503,E203 || true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Lint JavaScript
        working-directory: ./services/ai-agent
        run: |
          npm ci
          # Add eslint if available
          npm run lint || echo "No lint script found"