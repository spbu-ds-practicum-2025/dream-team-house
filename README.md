# ¬´–†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å AI-–∞–≥–µ–Ω—Ç–∞–º–∏¬ª

## –û–ø–∏—Å–∞–Ω–∏–µ

–£—á–µ–±–Ω—ã–π –ø—Ä–æ–µ–∫—Ç, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—â–∏–π
–ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ–π —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã. –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –∞–≤—Ç–æ–Ω–æ–º–Ω—ã—Ö AI-–∞–≥–µ–Ω—Ç–æ–≤, —Å–∏–º—É–ª–∏—Ä—É—é—â–∏—Ö –ø–æ–≤–µ–¥–µ–Ω–∏–µ
–ª—é–¥–µ–π-—Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤, —Å–æ–≤–º–µ—Å—Ç–Ω–æ —Å–æ–∑–¥–∞—é—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç, –ø—Ä–µ–¥–ª–∞–≥–∞—è –∏ —Å–æ–≥–ª–∞—Å—É—è –ø—Ä–∞–≤–∫–∏. –°–∏—Å—Ç–µ–º–∞ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∫–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã
—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π: —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º–∏ —É–∑–ª–∞–º–∏, –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
–∏ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
.
‚îú‚îÄ‚îÄ services/                    # –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Å–∏—Å—Ç–µ–º—ã
‚îÇ   ‚îú‚îÄ‚îÄ ai-agent/               # AI –∞–≥–µ–Ω—Ç—ã (JavaScript/Node.js 20)
‚îÇ   ‚îú‚îÄ‚îÄ text-service/           # –°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ (Python/FastAPI)
‚îÇ   ‚îú‚îÄ‚îÄ chat-service/           # –°–µ—Ä–≤–∏—Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –∞–≥–µ–Ω—Ç–æ–≤ (Python/FastAPI)
‚îÇ   ‚îú‚îÄ‚îÄ analytics-service/      # –°–µ—Ä–≤–∏—Å —Å–±–æ—Ä–∞ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ (Python/FastAPI)
‚îÇ   ‚îú‚îÄ‚îÄ frontend/               # –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (Next.js 15)
‚îÇ   ‚îú‚îÄ‚îÄ desktop-app/            # –î–µ—Å–∫—Ç–æ–ø–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (C++/Qt 6)
‚îÇ   ‚îî‚îÄ‚îÄ load-balancer/          # –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –Ω–∞–≥—Ä—É–∑–∫–∏ (Nginx)
‚îú‚îÄ‚îÄ docs/                       # –¢–† (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ), –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, UML
‚îú‚îÄ‚îÄ .github/                    # –®–∞–±–ª–æ–Ω—ã –∑–∞–¥–∞—á –∏ PR
‚îú‚îÄ‚îÄ docker-compose.yml          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
‚îî‚îÄ‚îÄ .env.example                # –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
```

–ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –≤ `services/` —Å–æ–¥–µ—Ä–∂–∏—Ç:
- `README.md` ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞, API, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- `Dockerfile` ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
- –§–∞–π–ª—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (`package.json`, `requirements.txt`, `CMakeLists.txt`)
- –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –≤ `src/` –∏–ª–∏ `app/`

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Docker 24+
- Docker Compose
- Git

### –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫

1. –°–∫–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:
   ```bash
   git clone https://github.com/spbu-ds-practicum-2025/dream-team-house.git
   cd dream-team-house
   ```

2. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –Ω–∞ –æ—Å–Ω–æ–≤–µ `.env.example`:
   ```bash
   cp .env.example .env
   # –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤–∞—à OPENAI_API_KEY
   ```

3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã:
   ```bash
   docker-compose up -d
   ```

4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ AI –∞–≥–µ–Ω—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5):
   ```bash
   docker-compose up -d --scale ai-agent=5
   ```

5. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:
   ```
   http://localhost:3000
   ```

6. API –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ Load Balancer:
   ```
   http://localhost/api/document/current
   http://localhost/api/chat/messages
   http://localhost/api/analytics/metrics
   ```

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã

```bash
docker-compose down
```

–î–ª—è –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ (–≤–∫–ª—é—á–∞—è –¥–∞–Ω–Ω—ã–µ –ë–î):
```bash
docker-compose down -v
```

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å

1. –°–æ–∑–¥–∞–π—Ç–µ –≤–µ—Ç–∫—É –æ—Ç `main`.
2. –ü–∏—à–∏—Ç–µ –∫–æ–¥ –≤ `services/<service>/`.
3. –ï—Å–ª–∏ –º–µ–Ω—è–µ—Ç–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É ‚Äî –æ–±–Ω–æ–≤–ª—è–π—Ç–µ `docs/tr.md`.
4. –î–µ–ª–∞–π—Ç–µ PR –≤ `main` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —à–∞–±–ª–æ–Ω PR.

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ PR (–º–∏–Ω–∏–º—É–º)

- –ü–æ–Ω—è—Ç–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
- –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ docs –ø—Ä–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
- –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (–æ–ø–∏—à–∏—Ç–µ –≤ `services/<service>/README.md`)
## Implemented Services Status

### ‚úÖ Completed Services

All core services have been fully implemented with comprehensive test coverage:

#### 1. Text Service (Python/FastAPI)
- ‚úÖ PostgreSQL database models (documents, edits, token_budget)
- ‚úÖ Document versioning and retrieval
- ‚úÖ Anchor-based edit operations (insert, replace, delete)
- ‚úÖ Replication between 3 nodes
- ‚úÖ Token budget tracking with 429 responses
- ‚úÖ Analytics event integration
- ‚úÖ **17 unit tests passing**

#### 2. Chat Service (Python/FastAPI)
- ‚úÖ Redis Streams integration (XADD/XRANGE)
- ‚úÖ Message posting and retrieval
- ‚úÖ 1000 message limit with MAXLEN
- ‚úÖ Structured message types (EditIntent, EditComment, EditOperation)
- ‚úÖ **6 unit tests passing**

#### 3. AI Agent (Node.js/JavaScript)
- ‚úÖ Full agent cycle implementation
- ‚úÖ OpenAI ProxyAPI integration with JSON mode
- ‚úÖ Anchor-based text operations
- ‚úÖ Retry logic with exponential backoff
- ‚úÖ Budget limit handling (429 responses)
- ‚úÖ **8 unit tests passing**

#### 4. Analytics Service (Python/FastAPI)
- ‚úÖ Event storage in PostgreSQL
- ‚úÖ Metrics aggregation (1h, 24h, 7d periods)
- ‚úÖ Time-series data generation
- ‚úÖ **5 unit tests passing**

#### 5. Load Balancer (Nginx)
- ‚úÖ Round-robin distribution across 3 Text Service nodes
- ‚úÖ Health checks with max_fails and fail_timeout
- ‚úÖ Automatic failover with proxy_next_upstream
- ‚úÖ Keepalive connections for performance
- ‚úÖ Status monitoring endpoint

### üéØ Total Test Coverage
**36 unit tests passing** (17 + 6 + 8 + 5)

## Edit Operations

All edit operations use **anchor-based positioning** from `multi_agent_editor_demo_Version2.py`:

### Insert Before/After
```json
{
  "operation": "insert",
  "anchor": "existing text",
  "position": "before",
  "new_text": "text to insert"
}
```

### Replace
```json
{
  "operation": "replace",
  "anchor": "text to find",
  "new_text": "replacement text"
}
```

### Delete
```json
{
  "operation": "delete",
  "anchor": "text to delete"
}
```

## Running Tests

### Python Services
```bash
# Text Service
cd services/text-service
pip install -r requirements.txt
pytest tests/ -v

# Chat Service  
cd services/chat-service
pip install -r requirements.txt
pytest tests/ -v

# Analytics Service
cd services/analytics-service
pip install -r requirements.txt
pytest tests/ -v
```

### AI Agent
```bash
cd services/ai-agent
npm install
npm test
```

## CI/CD Pipeline

GitHub Actions workflow (`.github/workflows/ci.yml`) includes:

1. **Unit Tests**: All services tested on every push
2. **Docker Builds**: All service images built and cached
3. **Integration Tests**: Services tested together with PostgreSQL and Redis
4. **E2E Tests**: Full system test with Docker Compose (on main/develop)
5. **Code Linting**: Python (flake8) and JavaScript

## API Endpoints

### Text Service
- `GET /health` - Health check
- `GET /api/document/current` - Get current document version
- `POST /api/document/init` - Initialize new document
- `POST /api/edits` - Submit edit from agent
- `GET /api/edits?limit=N&offset=M` - List edits with pagination
- `POST /api/replication/sync` - Accept replication from peer node
- `GET /api/replication/catch-up?since_version=N` - Get missing versions

### Chat Service
- `GET /health` - Health check
- `POST /api/chat/messages` - Post message to chat
- `GET /api/chat/messages?since=<timestamp>&limit=N` - Get messages

### Analytics Service
- `GET /health` - Health check
- `POST /api/analytics/events` - Record event
- `GET /api/analytics/metrics?period=<1h|24h|7d>` - Get aggregated metrics

## Configuration

### Environment Variables

**AI Agent**:
- `AGENT_ROLE` - Agent role/specialization
- `OPENAI_API_KEY` - OpenAI API key
- `OPENAI_BASE_URL` - API base URL (default: ProxyAPI)
- `TEXT_SERVICE_URL` - Text service URL
- `CHAT_SERVICE_URL` - Chat service URL
- `MAX_EDITS` - Maximum edits per agent (default: 5)
- `CYCLE_DELAY_MS` - Delay between cycles in ms (default: 2000)

**Text Service**:
- `DATABASE_URL` - PostgreSQL connection string
- `NODE_ID` - Node identifier (node-a, node-b, node-c)
- `NODE_NAME` - Human-readable node name
- `PEER_NODES` - Comma-separated peer node URLs
- `ANALYTICS_URL` - Analytics service URL

**Chat Service**:
- `REDIS_URL` - Redis connection string

**Analytics Service**:
- `DATABASE_URL` - PostgreSQL connection string

## Architecture Highlights

### Distributed Features
- **Replication**: 3-node Text Service with eventual consistency
- **Concurrency**: Multiple agents editing simultaneously with PostgreSQL transactions
- **Safety**: Transaction-based edits, replication ensures no data loss
- **Liveness**: Automatic node recovery with catch-up mechanism
- **Fault Tolerance**: Load balancer health checks and failover

### Text Operations
Based on `multi_agent_editor_demo_Version2.py`, all operations use text anchors:
- Find exact text fragments (anchor)
- Insert before/after anchor
- Replace anchor with new text
- Delete anchor
- No index-based operations for better reliability

